<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSig Wallet - Vanilla JS Example</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: white;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    
    h1 {
      margin-bottom: 10px;
      font-size: 2em;
    }
    
    .subtitle {
      opacity: 0.9;
      margin-bottom: 30px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    button {
      background: white;
      color: #667eea;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button.secondary {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    .status {
      margin-top: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      word-break: break-all;
      min-height: 100px;
    }
    
    .connected {
      color: #4ade80;
    }
    
    .disconnected {
      color: #f87171;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: white;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    
    .info-box {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      text-align: left;
    }
    
    .info-box h3 {
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    .info-box ul {
      list-style: none;
      padding: 0;
    }
    
    .info-box li {
      padding: 5px 0;
    }
    
    .environment-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }
    
    .environment-toggle select {
      background: transparent;
      color: white;
      border: 1px solid white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .environment-toggle option {
      background: #333;
    }
  </style>
</head>
<body>
  <div class="environment-toggle">
    <label>Environment: 
      <select id="envSelect">
        <option value="https://websig.xyz">Production (websig.xyz)</option>
        <option value="http://localhost:3001">Local Dev (localhost:3001)</option>
      </select>
    </label>
  </div>

  <div class="container">
    <div class="logo">üîê</div>
    <h1>WebSig Wallet Demo</h1>
    <p class="subtitle">Biometric Web3 Authentication</p>
    
    <div class="button-group">
      <button id="connectBtn">Connect Wallet</button>
      <button id="disconnectBtn" class="secondary" disabled>Disconnect</button>
    </div>
    
    <div class="button-group">
      <button id="signMessageBtn" disabled>Sign Message</button>
      <button id="sendTxBtn" disabled>Send 0.001 SOL</button>
    </div>
    
    <div class="status">
      <div id="statusText" class="disconnected">Not Connected</div>
      <div id="publicKey"></div>
      <div id="balance"></div>
    </div>
    
    <div class="info-box">
      <h3>‚ú® Features</h3>
      <ul>
        <li>‚úÖ Biometric authentication (Face ID, Touch ID)</li>
        <li>‚úÖ No browser extension required</li>
        <li>‚úÖ Works on mobile and desktop</li>
        <li>‚úÖ Beautiful UI</li>
        <li>‚úÖ Zero configuration needed</li>
      </ul>
    </div>
  </div>

  <!-- Load Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  
  <!-- Load the actual published adapter from CDN -->
  <script src="https://unpkg.com/@websig/wallet-adapter@latest/dist/index.js"></script>
  
  <script>
    // Check if the adapter loaded correctly
    if (typeof WebSigWalletAdapter === 'undefined') {
      // Fallback: Define the adapter inline (same as published version)
      window.WebSigWalletAdapter = class WebSigWalletAdapter {
        constructor() {
          this.name = 'WebSig';
          this.url = document.getElementById('envSelect').value;
          this.publicKey = null;
          this._popup = null;
          this._connected = false;
          this._responseHandlers = new Map();
          
          window.addEventListener('message', this._handleMessage.bind(this));
        }
        
        _handleMessage(event) {
          if (event.origin !== this.url) return;
          
          const { type, id, error, ...data } = event.data;
          
          // Handle async responses
          if (id && this._responseHandlers.has(id)) {
            const { resolve, reject } = this._responseHandlers.get(id);
            this._responseHandlers.delete(id);
            
            if (error) {
              reject(new Error(error));
            } else {
              resolve(data);
            }
            return;
          }
          
          // Handle events
          switch (type) {
            case 'websig:connected':
              this.publicKey = new solanaWeb3.PublicKey(data.publicKey);
              this._connected = true;
              break;
              
            case 'websig:disconnected':
              this._handleDisconnect();
              break;
          }
        }
        
        async connect() {
          if (this._connected) return;
          
          // Update URL in case environment changed
          this.url = document.getElementById('envSelect').value;
          
          const width = 420;
          const height = 600;
          const left = (window.screen.width - width) / 2;
          const top = (window.screen.height - height) / 2;
          
          const url = new URL('/connect', this.url);
          url.searchParams.set('origin', window.location.origin);
          url.searchParams.set('name', 'WebSig Demo');
          
          this._popup = window.open(
            url.toString(),
            'WebSig Wallet',
            `width=${width},height=${height},left=${left},top=${top}`
          );
          
          return new Promise((resolve, reject) => {
            const handleMessage = (event) => {
              if (event.origin !== this.url) return;
              
              if (event.data.type === 'websig:connected') {
                this.publicKey = new solanaWeb3.PublicKey(event.data.publicKey);
                this._connected = true;
                window.removeEventListener('message', handleMessage);
                resolve({ publicKey: this.publicKey });
              } else if (event.data.type === 'websig:rejected') {
                window.removeEventListener('message', handleMessage);
                reject(new Error('Connection rejected'));
              }
            };
            
            window.addEventListener('message', handleMessage);
            
            // Check if popup is closed
            const checkInterval = setInterval(() => {
              if (this._popup?.closed) {
                clearInterval(checkInterval);
                window.removeEventListener('message', handleMessage);
                reject(new Error('Connection cancelled'));
              }
            }, 500);
            
            // Timeout after 2 minutes
            setTimeout(() => {
              clearInterval(checkInterval);
              window.removeEventListener('message', handleMessage);
              reject(new Error('Connection timeout'));
            }, 120000);
          });
        }
        
        async disconnect() {
          if (this._popup && !this._popup.closed) {
            this._popup.close();
          }
          this._handleDisconnect();
        }
        
        _handleDisconnect() {
          this._popup = null;
          this.publicKey = null;
          this._connected = false;
          this._responseHandlers.clear();
        }
        
        async signMessage(message) {
          if (!this._connected) throw new Error('Not connected');
          
          this._popup?.focus();
          
          const id = Math.random().toString(36).substr(2, 9);
          this._popup?.postMessage({
            source: 'websig-adapter',
            id,
            method: 'signMessage',
            params: { 
              message: btoa(String.fromCharCode(...message))
            }
          }, this.url);
          
          return new Promise((resolve, reject) => {
            this._responseHandlers.set(id, { resolve, reject });
            
            setTimeout(() => {
              if (this._responseHandlers.has(id)) {
                this._responseHandlers.delete(id);
                reject(new Error('Signing timeout'));
              }
            }, 30000);
          });
        }
        
        async signTransaction(transaction) {
          if (!this._connected) throw new Error('Not connected');
          
          this._popup?.focus();
          
          const serialized = btoa(String.fromCharCode(...transaction.serialize({
            requireAllSignatures: false,
            verifySignatures: false
          })));
          
          const id = Math.random().toString(36).substr(2, 9);
          this._popup?.postMessage({
            source: 'websig-adapter',
            id,
            method: 'signTransaction',
            params: { 
              transaction: serialized
            }
          }, this.url);
          
          return new Promise((resolve, reject) => {
            this._responseHandlers.set(id, { resolve, reject });
            
            setTimeout(() => {
              if (this._responseHandlers.has(id)) {
                this._responseHandlers.delete(id);
                reject(new Error('Signing timeout'));
              }
            }, 30000);
          });
        }
      };
    }
    
    // Initialize wallet
    let wallet = new WebSigWalletAdapter();
    
    // UI Elements
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const signMessageBtn = document.getElementById('signMessageBtn');
    const sendTxBtn = document.getElementById('sendTxBtn');
    const statusText = document.getElementById('statusText');
    const publicKeyDiv = document.getElementById('publicKey');
    const balanceDiv = document.getElementById('balance');
    const envSelect = document.getElementById('envSelect');
    
    // Environment change handler
    envSelect.addEventListener('change', async () => {
      if (wallet._connected) {
        await wallet.disconnect();
        updateUI(false);
      }
      // Recreate wallet with new URL
      wallet = new WebSigWalletAdapter();
    });
    
    // Update UI function
    function updateUI(connected) {
      if (connected) {
        statusText.textContent = 'Connected';
        statusText.className = 'connected';
        publicKeyDiv.textContent = `Address: ${wallet.publicKey.toString()}`;
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        signMessageBtn.disabled = false;
        sendTxBtn.disabled = false;
        fetchBalance();
      } else {
        statusText.textContent = 'Not Connected';
        statusText.className = 'disconnected';
        publicKeyDiv.textContent = '';
        balanceDiv.textContent = '';
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect Wallet';
        disconnectBtn.disabled = true;
        signMessageBtn.disabled = true;
        sendTxBtn.disabled = true;
      }
    }
    
    // Fetch balance
    async function fetchBalance() {
      try {
        const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
        const balance = await connection.getBalance(wallet.publicKey);
        balanceDiv.textContent = `Balance: ${(balance / 1e9).toFixed(4)} SOL`;
      } catch (error) {
        console.error('Failed to fetch balance:', error);
      }
    }
    
    // Connect wallet
    connectBtn.addEventListener('click', async () => {
      try {
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
        
        await wallet.connect();
        updateUI(true);
        
      } catch (error) {
        console.error('Connection failed:', error);
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect Wallet';
        alert('Connection failed: ' + error.message);
      }
    });
    
    // Disconnect wallet
    disconnectBtn.addEventListener('click', async () => {
      await wallet.disconnect();
      updateUI(false);
    });
    
    // Sign message
    signMessageBtn.addEventListener('click', async () => {
      try {
        signMessageBtn.disabled = true;
        signMessageBtn.textContent = 'Signing...';
        
        const message = new TextEncoder().encode('Hello from WebSig! This is a test message.');
        const signature = await wallet.signMessage(message);
        
        alert('Message signed successfully!\n\nSignature: ' + 
          btoa(String.fromCharCode(...signature.signature || signature)));
        
      } catch (error) {
        console.error('Signing failed:', error);
        alert('Signing failed: ' + error.message);
      } finally {
        signMessageBtn.disabled = false;
        signMessageBtn.textContent = 'Sign Message';
      }
    });
    
    // Send transaction (0.001 SOL to self)
    sendTxBtn.addEventListener('click', async () => {
      try {
        sendTxBtn.disabled = true;
        sendTxBtn.textContent = 'Sending...';
        
        const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
        
        // Create a simple transfer to self
        const transaction = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: wallet.publicKey,
            toPubkey: wallet.publicKey, // Send to self for testing
            lamports: 1000000, // 0.001 SOL
          })
        );
        
        // Get recent blockhash
        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = wallet.publicKey;
        
        // Sign transaction
        const signed = await wallet.signTransaction(transaction);
        
        alert('Transaction signed!\n\nYou can now send it to the network.');
        
        // Note: In a real app, you would send the transaction:
        // const txid = await connection.sendRawTransaction(signed.serialize());
        
      } catch (error) {
        console.error('Transaction failed:', error);
        alert('Transaction failed: ' + error.message);
      } finally {
        sendTxBtn.disabled = false;
        sendTxBtn.textContent = 'Send 0.001 SOL';
      }
    });
    
    // Set default environment based on current location
    if (window.location.hostname === 'localhost') {
      envSelect.value = 'http://localhost:3001';
    }
  </script>
</body>
</html>