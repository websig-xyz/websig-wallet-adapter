<!DOCTYPE html>
<html>
<head>
    <title>Debug WebSig iframe</title>
</head>
<body>
    <h1>Debug WebSig iframe</h1>
    <button onclick="connectWallet()">Connect Wallet</button>
    <div id="status"></div>
    <iframe 
        id="websig-iframe"
        style="width: 600px; height: 700px; border: 1px solid #ccc; display: none;">
    </iframe>
    
    <script>
        // Override console methods to capture all logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            document.getElementById('status').innerHTML += '<div style="color:blue">LOG: ' + args.join(' ') + '</div>';
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            document.getElementById('status').innerHTML += '<div style="color:red">ERROR: ' + args.join(' ') + '</div>';
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            document.getElementById('status').innerHTML += '<div style="color:orange">WARN: ' + args.join(' ') + '</div>';
            originalWarn.apply(console, args);
        };
        
        // Listen for ALL messages
        let popupRef = null;
        window.addEventListener('message', (event) => {
            console.log('Message from:', event.origin, 'Data:', JSON.stringify(event.data));
            // Accept only messages from the iframe's actual origin
            const iframe = document.getElementById('websig-iframe');
            let allowedOrigin = '';
            try {
                allowedOrigin = new URL(iframe.src).origin;
            } catch {}
            if (allowedOrigin && event.origin !== allowedOrigin) {
                console.error('Unexpected message origin', event.origin, 'expected', allowedOrigin);
                return;
            }
            if (event.data && event.data.topic === 'websig:connected') {
                try { if (popupRef && !popupRef.closed) popupRef.close(); } catch {}
                document.getElementById('status').textContent = 'Connected: ' + (event.data.payload?.publicKey || '');
            }
        });
        
        function connectWallet() {
            const iframe = document.getElementById('websig-iframe');
            const defaultUrl = /^(localhost|127\.0\.0\.1|\[::1\])$/.test(window.location.hostname) ? 'http://localhost:3000' : 'https://websig.xyz';
            const websigUrl = window.localStorage.getItem('websigUrl') || defaultUrl;
            const url = new URL(websigUrl + '/connect');
            url.searchParams.set('origin', window.location.origin);
            
            const targetOrigin = url.origin;
            const isTargetLoopback = /^(https?:\/\/)(localhost|127\.0\.0\.1|\[::1\])(?::\d+)?$/.test(targetOrigin);
            
            if (isTargetLoopback) {
                // Use iframe for local target; relax frame-ancestors via sandbox flag
                try {
                    const isLoopbackPage = /^(localhost|127\.0\.0\.1|\[::1\])$/.test(window.location.hostname);
                    if (isLoopbackPage) url.searchParams.set('sandbox', 'true');
                } catch {}
                iframe.style.display = 'block';
                iframe.src = url.toString();
                iframe.setAttribute('allow', 'publickey-credentials-get *; publickey-credentials-create *; clipboard-write');
                iframe.addEventListener('load', () => {
                    console.log('iframe loaded, sending connect message');
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            topic: 'websig:connect',
                            payload: { adapter: 'websig-wallet-adapter' }
                        }, targetOrigin);
                    }, 500);
                });
            } else {
                // Use popup for production target to avoid frame-ancestors CSP
                const features = 'width=420,height=640,resizable,scrollbars=no,noopener,noreferrer';
                popupRef = window.open(url.toString(), 'websig_connect', features);
                if (!popupRef) {
                    console.error('Failed to open popup. Please allow popups for this site.');
                    return;
                }
                document.getElementById('status').textContent = 'Popup opened for WebSig connect...';
            }
        }
    </script>
</body>
</html>
